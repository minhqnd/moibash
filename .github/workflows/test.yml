name: Test Installation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test-install:
    name: Test Installation on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Install dependencies
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          sudo apt-get update
          sudo apt-get install -y curl
        elif [ "$RUNNER_OS" == "macOS" ]; then
          brew install curl
        fi
    
    - name: Create dummy .env file
      run: |
        cp .env.example .env
        # Add dummy API key for testing
        sed -i.bak "s/your-gemini-api-key-here/dummy-key-for-testing/" .env
    
    - name: Make scripts executable
      run: |
        chmod +x moibash.sh router.sh install.sh uninstall.sh update.sh
        chmod +x tools/*.sh tools/*/*.sh 2>/dev/null || true
    
    - name: Test moibash.sh exists
      run: |
        if [ ! -f "moibash.sh" ]; then
          echo "Error: moibash.sh not found"
          exit 1
        fi
        echo "✅ moibash.sh found"
    
    - name: Test router.sh exists
      run: |
        if [ ! -f "router.sh" ]; then
          echo "Error: router.sh not found"
          exit 1
        fi
        echo "✅ router.sh found"
    
    - name: Test --version flag
      run: |
        ./moibash.sh --version
    
    - name: Test --help flag
      run: |
        ./moibash.sh --help
    
    - name: Verify script structure
      run: |
        echo "Checking script structure..."
        
        # Check main components
        [ -d "tools" ] || exit 1
        [ -d "docs" ] || exit 1
        [ -f "README.md" ] || exit 1
        [ -f "INSTALL.md" ] || exit 1
        [ -f "QUICKSTART.md" ] || exit 1
        
        echo "✅ All required files and directories present"
    
    - name: Test syntax of shell scripts
      run: |
        echo "Testing shell script syntax..."
        
        # Test main scripts
        bash -n moibash.sh
        bash -n router.sh
        bash -n install.sh
        bash -n uninstall.sh
        bash -n update.sh
        
        echo "✅ All scripts have valid syntax"
